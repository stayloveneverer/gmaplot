<html xmlns="http://www.w3.org/1999/xhtml"> 
<head>
<title>PLOT</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<!-- Google Maps APIの読み込み -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXYxIgA0rrcF7FEzDfK9f4EelvfZY5cLY&callback=initMap"
  type="text/javascript"></script><style>
html,body{
	margin: 0;
	font-size:small;
	font-family:meiryo;
}
#map-canvas{
	width:79%;
	height:100%;
	float:left;
}
#menu{
	width:20%;
	height:100%;
	background-color:#ffffff;
	padding-left:10px;
	float:left;
}
#gps{
	font-size:12px;
	width:250px;
	height:300px;
}
#dist{
	border:1px solid #7e00bf;
	width:150px;
	margin-top:20px;
}
#dist th{ 
	background-color:#7e00bf; 
	/*border:1px solid #ccc; */
	text-align:center; 
	width:146px;
}
#dist td{ 
	border:1px solid #7e00bf;
	text-align:center; 
	width:146px;
	height:40px;
}
</style>

<script type="text/javascript">

var poly;
var map;
var cnt=0;
var marker;
var path;

$(function(){
	initialize();
	$("#run").click(function(){
		dist_calc();
	});
});

	
function initialize() {
  //Form要素を取得する
  var form = document.forms.myform;
  //ファイルが読み込まれた時の処理
  form.myfile.addEventListener('change', function(e) {
        var result = e.target.files[0];
 
        //FileReaderのインスタンスを作成する
        var reader = new FileReader();

        //読み込んだファイルの中身を取得する
        reader.readAsText( result );

      //ここにファイル取得処理を書く
      reader.addEventListener( 'load', function() {
    
        //CSVの各データ毎に読み込む
        console.log( reader.result.split('n') );

        //ファイルの中身をtextarea内に表示する
        form.gps.textContent = reader.result; 
    })
    })	
  var shiroi = new google.maps.LatLng(33.14944701,129.748153);
  var myOptions = {
    zoom: 15,
    center: shiroi,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    draggableCursor: "default"
  };

  map = new google.maps.Map(document.getElementById('map-canvas'), myOptions);

}

function dist_calc(){
  var input_message = document.getElementById("input_message").value;
  if (input_message=='good'){
  var polyOptions = {
    strokeColor: '#0000ff',
    strokeOpacity: 0.8,
    strokeWeight: 3
  }
  }
  if (input_message=='normal'){
  var polyOptions = {
    strokeColor: '#ffff00',
    strokeOpacity: 0.8,
    strokeWeight: 3
  }
  }
  if (input_message=='bad'){
  var polyOptions = {
    strokeColor: '#ff0000',
    strokeOpacity: 0.8,
    strokeWeight: 3
  }
  }
  poly = new google.maps.Polyline(polyOptions);
  poly.setMap(map);
	var gpsStr  = $("#gps").val();
	var gpsArry = gpsStr.split("\n");
	flen = gpsArry.length;
	//最終データが改行で終了している場合を考慮しundefinedか否かを判定する
	var len = 0;
	for(var i=0; i < gpsArry.length; i++){
		if((typeof gpsArry[i] === "undefined") || (gpsArry[i] === "")){
			break;
		}else{
			len ++;
		}
	}
	path = poly.getPath();
	var bounds = new google.maps.LatLngBounds();
	var latLngArry = [];
	for(var i=0; i < len; i++){
		var wLatLng = new google.maps.LatLng(gpsArry[i].split(",")[0], gpsArry[i].split(",")[1]);
		path.push(wLatLng);
		bounds.extend(wLatLng);
		latLngArry[i] = wLatLng;
	}
	map.fitBounds(bounds);
	// Googleの関数を使用した距離計算
	//var dist = 0;
	/*
	for(var i=1; i < len; i++){ 
		dist += google.maps.geometry.spherical.computeDistanceBetween(latLngArry[i - 1], latLngArry[i]);
	}
	*/
	var dist = google.maps.geometry.spherical.computeLength(path);
	dist = Math.round(dist)/1000.0
	$("#ruler").text(dist);
}  

</script>
</head>
<body onload="initialize()">
<div id="container">
<div id="map-canvas"></div>
<div id="menu">
<!--<p>
距離：<input type="text" id="dist" value="" size="12" style="text-align: right;">&nbsp;Km
</p>-->
<table id="dist">
	<tr>
		<th>距離</th>
		<!--<th>時間</th>-->
	</tr>
	<tr>
		<td><span style="font-size:20px;font-weight:bold;" id="ruler">0</span>km</td>
		<!--<td><span style="font-size:20px;font-weight:bold;" id="time">0</span>時間</td>-->
	</tr>
</table>

<p><label for="form1">乗り心地 [good normal bad]</label><br/>
<form id="form1" action="#">
	<input type="text" id="input_message" value="">
</form>
<p><label for="gps">緯度経度データ</label><br/>
<form name="myform">
	<input name="myfile" type="file" /><br/>
	<textarea name="gps" id="gps">
	</textarea>
</form>
</p>
<p><input type="button" id="run"   value="PLOT"/>
</p>
<p>
<a target="_blank" href="usage.html"></a></p>
</div>
</div>
</body>
</html>